// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/core/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  avatar        String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  emailVerified Boolean    @default(false)
  image         String?
  sessions      Session[]
  accounts      Account[]
  userRoles     UserRole[]

  // Relaciones con módulo de Leads
  leadsAssigned     Lead[]              @relation("LeadAssignedTo")
  leadsCreated      Lead[]              @relation("LeadCreatedBy")
  leadStatusChanges LeadStatusHistory[]
  interactions      Interaction[]
  attachments       Attachment[]

  // Relaciones con módulo de Notificaciones
  notificationsCreated Notification[] @relation("NotificationCreatedBy")

  // Relaciones con módulo de Clientes
  clientsGenerated Client[] @relation("ClientGenerator")
  clientsCreated   Client[] @relation("ClientCreatedBy")

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeTenantId String?
  activeTenant   Tenant? @relation(fields: [activeTenantId], references: [id], onDelete: SetNull)

  @@unique([token])
  @@index([userId])
  @@index([activeTenantId])
  @@index([expiresAt]) // Para cleanup de sesiones expiradas
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// Tenants

model Tenant {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  userRoles UserRole[]
  sessions  Session[]
  vacancies Vacancy[]
  roles     Role[]

  // Relaciones con módulo de Leads
  leads             Lead[]
  sectors           Sector[]
  subsectors        Subsector[]
  leadOrigins       LeadOrigin[]
  contacts          Contact[]
  interactions      Interaction[]
  leadStatusHistory LeadStatusHistory[]
  attachments       Attachment[]

  // Relaciones con módulo de Notificaciones
  notifications Notification[]

  // Relaciones con módulo de Clientes
  clients Client[]

  @@map("tenant")
}

// Roles y permisos

model Role {
  id          String           @id @default(uuid())
  name        String
  tenantId    String?
  tenant      Tenant?          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users       UserRole[]
  permissions RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([name, tenantId])
  @@index([tenantId])
  @@index([name])
  @@index([tenantId, name]) // Covering index para queries con filtros compuestos
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  tenantId  String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, tenantId, roleId])
  @@index([userId])
  @@index([roleId])
  @@index([tenantId])
  @@index([userId, tenantId]) // CRÍTICO: Optimiza getUserPermissions() - 60-80% mejora
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  resource    String
  action      String
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([resource])
  @@index([name])
}

// =============================================
// ENUMS DEL MÓDULO DE NOTIFICACIONES
// =============================================

enum NotificationProvider {
  EMAIL
  TELEGRAM
  WHATSAPP
  SMS
}

enum NotificationStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// =============================================
// ENUMS DEL MÓDULO DE LEADS
// =============================================

enum LeadStatus {
  CONTACTO
  CONTACTO_CALIDO
  SOCIAL_SELLING
  CITA_AGENDADA
  CITA_ATENDIDA
  CITA_VALIDADA
  POSICIONES_ASIGNADAS
  STAND_BY
}

enum AttachableType {
  LEAD
  CONTACT
  INTERACTION
  VACANCY
}

// =============================================
// TABLAS DE CATÁLOGO
// =============================================

model Sector {
  id        String   @id @default(uuid())
  name      String
  isActive  Boolean  @default(true)
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subsectors Subsector[]
  leads      Lead[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@index([isActive])
  @@map("sector")
}

model Subsector {
  id        String   @id @default(uuid())
  name      String
  sectorId  String
  sector    Sector   @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads Lead[]

  @@unique([name, sectorId])
  @@index([sectorId])
  @@index([tenantId])
  @@index([isActive])
  @@map("subsector")
}

model LeadOrigin {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leads   Lead[]
  clients Client[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@index([isActive])
  @@map("lead_origin")
}

// =============================================
// ENTIDADES CORE DEL MÓDULO DE LEADS
// =============================================

model Lead {
  id                    String     @id @default(uuid())
  companyName           String
  normalizedCompanyName String     @default("")
  website               String?
  linkedInUrl           String?
  countryCode           String?
  regionCode            String?
  postalCode            String?
  subOrigin             String?
  employeeCount         String?
  notes                 String?    @db.Text
  status                LeadStatus @default(CONTACTO)

  // Relaciones con catálogos
  sectorId    String?
  sector      Sector?     @relation(fields: [sectorId], references: [id], onDelete: SetNull)
  subsectorId String?
  subsector   Subsector?  @relation(fields: [subsectorId], references: [id], onDelete: SetNull)
  originId    String?
  origin      LeadOrigin? @relation(fields: [originId], references: [id], onDelete: SetNull)

  // Usuario asignado
  assignedToId String?
  assignedTo   User?   @relation("LeadAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)

  // Soft delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Relación con tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auditoría
  createdById String?
  createdBy   User?    @relation("LeadCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones hijas (parte del agregado)
  contacts      Contact[]
  statusHistory LeadStatusHistory[]
  attachments   Attachment[]

  // Relación con Cliente (cuando el Lead se convierte)
  client Client?

  @@index([tenantId])
  @@index([status])
  @@index([sectorId])
  @@index([subsectorId])
  @@index([originId])
  @@index([assignedToId])
  @@index([isDeleted])
  @@index([tenantId, status])
  @@index([tenantId, isDeleted])
  @@index([tenantId, createdAt])
  @@index([tenantId, isDeleted, normalizedCompanyName])
  @@index([countryCode])
  @@index([regionCode])
  @@index([tenantId, countryCode])
  @@index([tenantId, countryCode, regionCode])
  @@map("lead")
}

model LeadStatusHistory {
  id             String     @id @default(uuid())
  leadId         String
  lead           Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  previousStatus LeadStatus
  newStatus      LeadStatus
  changedById    String
  changedBy      User       @relation(fields: [changedById], references: [id], onDelete: Cascade)
  tenantId       String
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt      DateTime   @default(now())

  @@index([leadId])
  @@index([tenantId])
  @@index([changedById])
  @@index([createdAt])
  @@map("lead_status_history")
}

model Contact {
  id          String      @id @default(uuid())
  firstName   String
  lastName    String
  email       String?
  phone       String?
  position    String?
  linkedInUrl String?
  isPrimary   Boolean     @default(false)
  tag         LeadStatus?
  notes       String?     @db.Text

  // Relación con Lead (Aggregate Root)
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Relación con tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  interactions Interaction[]
  attachments  Attachment[]

  @@index([leadId])
  @@index([tenantId])
  @@index([email])
  @@index([tenantId, leadId]) // Optimiza findByLeadId con tenant scope
  @@map("contact")
}

model Interaction {
  id      String   @id @default(uuid())
  type    String // "CALL", "EMAIL", "MEETING", "NOTE", "LINKEDIN", etc.
  subject String
  content String?  @db.Text
  date    DateTime @default(now())

  // Relación con Contact
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Usuario que registró la interacción
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Relación con tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  attachments Attachment[]

  @@index([contactId])
  @@index([tenantId])
  @@index([createdById])
  @@index([date])
  @@index([type])
  @@index([contactId, date])    // Optimiza orderBy: { date: "desc" } por contacto
  @@index([tenantId, contactId]) // Optimiza queries con tenant scope
  @@map("interaction")
}

// =============================================
// SISTEMA POLIMÓRFICO DE ARCHIVOS
// =============================================

model Attachment {
  id             String         @id @default(uuid())
  fileName       String
  fileUrl        String
  fileSize       Int
  mimeType       String
  attachableType AttachableType

  // Relaciones polimórficas opcionales
  leadId        String?
  lead          Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contactId     String?
  contact       Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  interactionId String?
  interaction   Interaction? @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  // Relación con tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auditoría
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())

  @@index([leadId])
  @@index([contactId])
  @@index([interactionId])
  @@index([tenantId])
  @@index([attachableType])
  @@map("attachment")
}

// Vacantes

enum VacancyStatus {
  DRAFT
  OPEN
  CLOSED
  ARCHIVED
}

model Vacancy {
  id          String        @id @default(cuid())
  title       String
  description String        @db.Text
  status      VacancyStatus @default(DRAFT)
  department  String?
  location    String?
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([tenantId, status])
  @@map("vacancy")
}

// =============================================
// SISTEMA DE NOTIFICACIONES
// =============================================

model Notification {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider NotificationProvider
  status   NotificationStatus   @default(PENDING)
  priority NotificationPriority @default(MEDIUM)

  recipient String
  subject   String?
  body      String  @db.Text
  metadata  Json?

  sentAt     DateTime?
  failedAt   DateTime?
  error      String?   @db.Text
  retryCount Int       @default(0)
  maxRetries Int       @default(3)

  // Auditoría
  createdById String?
  createdBy   User?    @relation("NotificationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([provider])
  @@index([tenantId, status])
  @@map("notification")
}

// =============================================
// MÓDULO DE CLIENTES (FINANZAS)
// =============================================

model Client {
  id     String @id @default(uuid())
  nombre String // Copiado de Lead.companyName

  // Trazabilidad al Lead original
  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Restrict)

  // Usuario que generó el cliente (assignedTo del Lead)
  generadorId String?
  generador   User?   @relation("ClientGenerator", fields: [generadorId], references: [id], onDelete: SetNull)

  // Origen del cliente (mismo que el Lead)
  origenId String?
  origen   LeadOrigin? @relation(fields: [origenId], references: [id], onDelete: SetNull)

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auditoría
  createdById String?
  createdBy   User?    @relation("ClientCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([generadorId])
  @@index([origenId])
  @@index([tenantId, createdAt])
  @@map("client")
}
